<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Te amo mi bichita</title>
<style>
body { font-family: Arial, sans-serif; text-align:center; background:#f2f2f2; margin:0; padding:20px; }
h1 { margin-bottom:20px; }
.player-buttons { display:flex; justify-content:space-around; margin:20px 0; }
.player-btn { flex:1; margin:10px; padding:30px; font-size:24px; font-weight:bold; border:none; border-radius:15px; cursor:pointer; color:white; }
#player1-btn { background-color:#fcc7ef; }
#player2-btn { background-color:#9bd6f8; }
#message { font-size:20px; margin:15px 0; font-weight:bold; }
.scores { display:flex; justify-content:space-around; margin-top:20px; }
.score-box { background:white; padding:15px; border-radius:10px; box-shadow:0px 3px 6px rgba(0,0,0,0.2); width:200px; }
.score-box h2 { margin:5px 0; }
.score-buttons { display:flex; justify-content:space-between; margin-top:10px; }
.score-btn { flex:1; margin:0 5px; padding:10px; font-size:16px; border:none; border-radius:8px; cursor:pointer; font-weight:bold; color:white; }
.add { background-color:#2ecc71; }
.subtract { background-color:#e67e22; }

#controls { margin:20px 0; display:flex; flex-direction:column; align-items:center; }
#progress-container { width:300px; height:10px; background:#ccc; border-radius:5px; margin-top:10px; overflow:hidden; }
#progress { height:100%; width:0; background:#2ecc71; border-radius:5px; transition: width 0.1s linear; }
#yt-player-container { width:0; height:0; overflow:hidden; }
#song-title { font-size:18px; font-weight:bold; margin-top:10px; filter:blur(5px); }
</style>
</head>
<body>

<h1>ğŸµğŸ’• Adivina la cancion con Cele y Tade ğŸ’•ğŸµ</h1>

<div id="controls">
  <div>
    <button onclick="togglePlay()">â–¶ï¸ Play/Pause</button>
    <button onclick="nextSong()">â­ Siguiente CanciÃ³n</button>
    <button onclick="revealSong()">ğŸ‘€ Revelar CanciÃ³n</button>
      <div id="add-song" style="margin-top:20px; background:white; padding:15px; border-radius:10px; box-shadow:0 3px 6px rgba(0,0,0,0.2); width:320px;">
    <h3>Agregar nueva canciÃ³n ğŸ¶</h3>
    <input type="text" id="song-url" placeholder="URL de YouTube" style="width:100%; padding:8px; margin-bottom:8px;">
    <input type="text" id="song-name" placeholder="TÃ­tulo (opcional)" style="width:100%; padding:8px; margin-bottom:8px;">
    <button onclick="addSong()" style="padding:8px 16px; background-color:#2ecc71; border:none; border-radius:8px; color:white; font-weight:bold; cursor:pointer;">Agregar</button>
  </div>
  </div>
  <div id="progress-container">
    <div id="progress"></div>
  </div>
</div>

<div id="yt-player-container">
  <div id="player"></div>
</div>

<div class="player-buttons">
  <button id="player1-btn" class="player-btn" onclick="playerPressed(1)">Cele</button>
  <button id="player2-btn" class="player-btn" onclick="playerPressed(2)">Tade</button>
</div>
<button id="reset-btn" onclick="resetButtons()">Resetear Turno</button>
<div id="message"></div>
<div id="song-title"></div>

<div class="scores">
  <div class="score-box">
    <h2>Cele: <span id="score1">0</span></h2>
    <div class="score-buttons">
      <button class="score-btn add" onclick="addPoint(1)">+1</button>
      <button class="score-btn subtract" onclick="subtractPoint(1)">-1</button>
    </div>
  </div>
  <div class="score-box">
    <h2>Tade: <span id="score2">0</span></h2>
    <div class="score-buttons">
      <button class="score-btn add" onclick="addPoint(2)">+1</button>
      <button class="score-btn subtract" onclick="subtractPoint(2)">-1</button>
    </div>
  </div>
</div>

<!-- ğŸ”¥ Firebase + YouTube -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-analytics-compat.js"></script>
<script src="https://www.youtube.com/iframe_api"></script>

<script>
const firebaseConfig = {
  apiKey:"AIzaSyDnm7xpjFtaqwYeCRJG0ms8QR7J9k010Tk",
  authDomain:"juegoadivinalacancion-5152e.firebaseapp.com",
  projectId:"juegoadivinalacancion-5152e",
  storageBucket:"juegoadivinalacancion-5152e.firebasestorage.app",
  messagingSenderId:"543704119927",
  appId:"1:543704119927:web:613939b3ffee9dab25e472",
  measurementId:"G-TYSK5TJCMZ"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();

let score1=0, score2=0, isPlaying=false;
let player;
const playlist=[
  {id:"dQw4w9WgXcQ", title:"CanciÃ³n Misteriosa 1"},
  {id:"3JZ4pnNtyxQ", title:"CanciÃ³n Misteriosa 2"},
  {id:"L_jWHffIx5E", title:"CanciÃ³n Misteriosa 3"}
];
let currentSong=playlist[0];

// --- YouTube API ---
function onYouTubeIframeAPIReady(){
  player = new YT.Player('player', {
    videoId:currentSong.id,
    events:{ 'onReady':()=>player.pauseVideo(), 'onStateChange': syncProgress }
  });
}

function syncProgress(event){
  if(event.data === YT.PlayerState.PLAYING) updateProgress();
}
function updateProgress(){
  if(player && player.getCurrentTime){
    const pct=(player.getCurrentTime()/player.getDuration())*100;
    document.getElementById("progress").style.width=pct+"%";
    if(isPlaying) requestAnimationFrame(updateProgress);
  }
}

// --- Botones ---
function playerPressed(num){ db.ref('game/lastClick').set({player:num,time:Date.now()}); }
function resetButtons(){
  db.ref('game/lastClick').set(null);
}
db.ref('game/lastClick').on('value', snap=>{
  const d=snap.val(); if(!d) return;
  document.getElementById("message").innerText=d.player===1?"Â¡Cele presionÃ³ primero!":"Â¡Tade presionÃ³ primero!";
});

// --- Puntajes ---
function addPoint(n){ db.ref('game/score'+n).set((n===1?++score1:++score2)); }
function subtractPoint(n){ db.ref('game/score'+n).set((n===1?--score1:--score2)); }
db.ref('game/score1').on('value', s=>{score1=s.val()||0; document.getElementById("score1").innerText=score1;});
db.ref('game/score2').on('value', s=>{score2=s.val()||0; document.getElementById("score2").innerText=score2;});

// --- Sincronizar Reproductor ---
function togglePlay(){ db.ref('game/play').set(!isPlaying); }
db.ref('game/play').on('value', s=>{
  const v=s.val();
  if(player){
    if(v) player.playVideo(); else player.pauseVideo();
    isPlaying=v;
  }
});

function nextSong(){
  const next=playlist[Math.floor(Math.random()*playlist.length)];
  db.ref('game/song').set(next);
}
db.ref('game/song').on('value', s=>{
  const v=s.val(); if(!v) return;
  currentSong=v;
  if(player) player.loadVideoById(currentSong.id);
  document.getElementById("song-title").innerText="";
});

function revealSong(){ db.ref('game/reveal').set(currentSong.title); }
db.ref('game/reveal').on('value', s=>{
  const title=s.val();
  if(title) document.getElementById("song-title").innerText=title;
});
function extractYouTubeID(url) {
  try {
    const regex = /(?:youtube\.com\/(?:[^\/\n\s]+\/\S+\/|(?:v|e(?:mbed)?)\/|.*[?&]v=)|youtu\.be\/)([a-zA-Z0-9_-]{11})/;
    const match = url.match(regex);
    return match ? match[1] : null;
  } catch {
    return null;
  }
}

function addSong() {
  const url = document.getElementById("song-url").value.trim();
  const name = document.getElementById("song-name").value.trim() || "CanciÃ³n Misteriosa";
  const id = extractYouTubeID(url);

  if (!id) {
    alert("âŒ URL de YouTube no vÃ¡lida");
    return;
  }

  const newSong = { id, title: name };

  // Guardamos la canciÃ³n en Firebase
  db.ref('game/playlist').push(newSong);

  // Limpiamos los campos
  document.getElementById("song-url").value = "";
  document.getElementById("song-name").value = "";

  alert("âœ… CanciÃ³n agregada correctamente");
}

// --- Sincronizar lista de reproducciÃ³n global ---
db.ref('game/playlist').on('value', snap => {
  const list = snap.val();
  if (list) {
    playlist.length = 0; // vaciamos la lista local
    Object.values(list).forEach(song => playlist.push(song));
    console.log("ğŸµ Lista sincronizada:", playlist);
  }
});
</script>

</body>
</html>
